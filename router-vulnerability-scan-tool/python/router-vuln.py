#!/usr/bin/python3
from selenium import webdriver
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import NoSuchElementException
from selenium.common.exceptions import TimeoutException
import time
import re
import sys
import json

result = []
keywordsArray = []
keywords = ""
for index in range(1,len(sys.argv)):
    keywords += sys.argv[index] + " "
    keywordsArray.append(sys.argv[index])   

options = Options()
options.add_argument("--headless")
options.headless = True

driver = webdriver.Firefox(options=options, executable_path=r'python/drivers/geckodriver')

driver.get('https://www.exploit-db.com/')

delay = 20 # seconds
try:
    myElem = WebDriverWait(driver, delay).until(EC.presence_of_element_located((By.XPATH, '//div[contains(@id,\'exploits-table_filter\')]/label/input')))
    myElem.click()
    myElem.send_keys(keywords)
    time.sleep(6)
    #verifico che ci sia la tabella
    html = driver.page_source
    
    regex = re.findall(r'<tr.+?tabindex="0">(?P<date>.*?)<.+?href="(?P<link>\/exploits\/\d+)">(?P<desc>.+?)<', html)
    if regex:
    	for x in regex:
    		find = True
    		for key in keywordsArray:
    			if key.lower() not in x[2].lower():
    				find = False
    				continue
    		if find:
    			result.append({'Link':x[1], 'CVE':x[0], 'Desc':x[2]})
    	if len(result) > 0:
    		json_format = json.dumps(result)
    		print(json_format, end = '')
    		
    	else:
    		result.append({'Link':"null", 'CVE':"null", 'Desc':"null"})
    		json_format = json.dumps(result)
    		print(json_format, end = '')
    else:
    	result.append({'Link':"null", 'CVE':"null", 'Desc':"null"})
    	json_format = json.dumps(result)
    	print(json_format, end = '')   

except TimeoutException:
	print("errore", end = '')
	driver.quit()
	sys.exit()	

driver.quit()    

